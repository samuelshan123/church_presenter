<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presenter</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+Thambi+2:wght@400..800&display=swap');

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, rgb(34, 34, 34), black);
      font-family: "Baloo Thambi 2", system-ui;
      font-optical-sizing: auto;
      position: relative;
      overflow: hidden;
    }

    #background-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      display: none;
    }

    #background-image.portrait {
      object-fit: contain;
      object-position: center;
    }

    #background-image.landscape {
      object-fit: cover;
      object-position: center;
    }

    #background-image.fullscreen {
      object-fit: cover;
    }

    #content-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      display: none;
      transition: transform 0.3s ease;
      transform-origin: center center;
    }

    #content-image.cover {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    #content-image.contain {
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
    }

    #content-image.fill {
      width: 100vw;
      height: 100vh;
      object-fit: fill;
    }

    #content-image.original {
      width: auto;
      height: auto;
      object-fit: none;
    }

    #content {
      font-weight: bold;
      color: #fff;
      text-align: center;
      font-size: clamp(2rem, 6vw, 3.5rem);
      word-break: break-word;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.25), 0 1px 0 #fff;
      position: relative;
      z-index: 1;
    }

    #book {
      font-weight: bold;
      color: #fff;
      text-align: center;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 0.5em;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.25), 0 1px 0 #fff;
      position: relative;
      z-index: 1;
    }
  </style>
</head>

<body>
  <img id="background-image" alt="Background">
  <img id="content-image" alt="Content Image">
  <div style="padding: 20px; position: relative; z-index: 1;" id="text-container">
    <div id="book"></div>
    <div id="content">Welcome</div>
  </div>
  <script>
    let socket;

    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      socket = new WebSocket(`${protocol}//${location.host}/api/ws`);

      socket.onopen = function () {
        console.log('WebSocket connected');
      };

      socket.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          console.log(data);
          let type = data.type; // e.g., 'text', 'bible', 'song', 'image'
          let config = data.config || {};
          let background = data.background || {};
          let imageConfig = data.imageConfig || {};
          let metadata = data.metadata || {};
          let msg = data.content;
          if (!msg) msg = "";

          // Apply config values if not default
          const body = document.body;
          const contentEl = document.getElementById("content");
          const bookEl = document.getElementById("book");
          const bgImage = document.getElementById("background-image");
          const contentImage = document.getElementById("content-image");
          const textContainer = document.getElementById("text-container");

          // Handle content type: image
          if (type === 'image' && metadata.imagePath) {
            // Show content image, hide text
            const encodedPath = encodeURIComponent(metadata.imagePath);
            contentImage.src = `/api/image/${encodedPath}`;
            contentImage.style.display = 'block';
            textContainer.style.display = 'none';

            // Get display mode and zoom level
            const displayMode = imageConfig.displayMode || 'contain';
            const zoomLevel = imageConfig.zoomLevel || 1.0;
            
            console.log('Image Config:', {
              displayMode: displayMode,
              zoomLevel: zoomLevel,
              imagePath: metadata.imagePath
            });

            // Apply display mode
            contentImage.classList.remove('cover', 'contain', 'fill', 'original');
            contentImage.classList.add(displayMode);

            // Apply zoom level with proper transform
            contentImage.style.transform = `translate(-50%, -50%) scale(${zoomLevel})`;
          } else {
            // Show text content, hide content image
            contentImage.style.display = 'none';
            textContainer.style.display = 'block';
          }

          // Handle background image
          if (background.imagePath) {
            bgImage.src = '/api/background';
            bgImage.style.display = 'block';
            
            // Remove all display type classes
            bgImage.classList.remove('fullscreen', 'portrait', 'landscape');
            
            // Add the current display type class
            if (background.displayType) {
              bgImage.classList.add(background.displayType);
            } else {
              bgImage.classList.add('fullscreen');
            }
          } else {
            bgImage.style.display = 'none';
            bgImage.src = '';
          }

          // Background color (only applies if no image)
          if (config.bg && config.bg !== "default") {
            body.style.background = config.bg;
          } else {
            body.style.background = "radial-gradient(circle, rgb(34, 34, 34), black)";
          }

          // Foreground color
          if (config.fg && config.fg !== "default") {
            contentEl.style.color = config.fg;
            bookEl.style.color = config.fg;
          } else {
            contentEl.style.color = "#fff";
            bookEl.style.color = "#fff";
          }

          // Font size
          if (config.fontSize && config.fontSize !== "default") {
            contentEl.style.fontSize = config.fontSize + "px";
            bookEl.style.fontSize = (config.fontSize * 0.7) + "px";
          } else {
            contentEl.style.fontSize = "clamp(2rem, 6vw, 3.5rem)";
            bookEl.style.fontSize = "clamp(1.5rem, 4vw, 2.5rem)";
          }

          // Font family
          if (config.font && config.font !== "default") {
            body.style.fontFamily = config.font;
          } else {
            body.style.fontFamily = '"Baloo Thambi 2", system-ui';
          }

          document.getElementById("book").innerText = (type === 'bible' && metadata.book) ? metadata.book : '';
          document.getElementById("content").innerText = msg;
        } catch (err) {
          console.error('Parse error:', err);
        }
      };

      socket.onclose = function () {
        console.log('WebSocket disconnected, attempting to reconnect...');
        setTimeout(connectWebSocket, 3000);
      };

      socket.onerror = function (error) {
        console.error('WebSocket error:', error);
      };
    }

    connectWebSocket();
  </script>
</body>

</html>